<!DOCTYPE html>
<html>

<head>
  <title>SocketViewer</title>
  <script type="text/javascript" src="js/lib/dat.gui.min.js"></script>
  <script type="text/javascript" src="js/lib/protobuf.min.js"></script>
  <script type="text/javascript" src="js/lib/stats.min.js"></script>
  <script type="text/javascript" src="js/lib/three.min.js"></script>
  <script type="text/javascript" src="js/ViewControls.js"></script>
  <script type="text/javascript" src="js/Mouse.js"></script>
  <script type="text/javascript" src="js/PointCloud.js"></script>
  <script type="text/javascript" src="js/CameraFrames.js"></script>
  <script type="text/javascript" src="js/MarkerIndicators.js"></script>

  <style>
    body {
      margin: 0;
      overflow: hidden;
    }

    #thumb {
      position: absolute;
      top: 0px;
      left: 80px;
      background-color: #000;
    }

    #telemetry-panels {
      position: absolute;
      bottom: 10px;
      left: 10px;
      display: flex;
      gap: 10px;
      z-index: 5;
    }

    .telemetry-panel {
      padding: 8px 12px;
      background: rgba(0, 0, 0, 0.65);
      color: #fff;
      font-family: monospace;
      font-size: 12px;
      line-height: 1.4;
      border-radius: 4px;
      width: 150px;
      min-height: 150px;
      white-space: normal;
    }

    .telemetry-panel strong {
      display: block;
      font-size: 13px;
      margin-bottom: 4px;
    }

    .telemetry-panel .timestamp {
      font-size: 11px;
      color: #ccc;
      margin-bottom: 4px;
    }

    .pose-rotation {
      font-family: monospace;
      white-space: pre;
      min-height: 60px;
    }

    #control-panel {
      position: absolute;
      bottom: 10px;
      right: 10px;
      width: 240px;
      min-height: 150px;
      padding: 8px 12px;
      background: rgba(0, 0, 0, 0.65);
      color: #fff;
      font-family: monospace;
      border-radius: 4px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    #control-panel button {
      width: 100%;
      padding: 6px;
      border: 1px solid #fff;
      background: rgba(0, 0, 0, 0.4);
      color: #fff;
      cursor: pointer;
      font-family: monospace;
      font-size: 12px;
      border-radius: 3px;
    }

    #control-panel button:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    #control-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      grid-auto-rows: minmax(32px, auto);
      gap: 6px;
    }

    .mode-row {
      display: flex;
      gap: 6px;
    }

    .mode-row button {
      width: auto;
      flex: 1;
    }

    #slam2gps-toggle.active,
    #calibrate-toggle.active,
    #visual-slam-toggle.active {
      background: #147a14;
    }

    #slam2gps-toggle.inactive,
    #calibrate-toggle.inactive,
    #visual-slam-toggle.inactive {
      background: #7a1414;
    }

    #btn-save-csv.csv-active {
      background: #147a14;
      color: #fff;
    }
  </style>
</head>

<body>
  <script>
    window.__INITIAL_TELEMETRY__ = <%- JSON.stringify(initialTelemetry || {}) %>;
  </script>
  <canvas id="thumb" height="300" width="600"></canvas>
  <div id="Stats-output">
  </div>
  <div id="WebGL-output">
  </div>
  <div id="telemetry-panels">
    <div id="pose-panel" class="telemetry-panel">
      <strong>SLAM Pose</strong>
      <div id="pose-updated" class="timestamp">Updated: --</div>
      <div id="pose-body">Waiting for pose data...</div>
    </div>
    <div id="gps-panel" class="telemetry-panel">
      <strong>MavLink Data</strong>
      <div id="gps-updated" class="timestamp">Updated: --</div>
      <div id="gps-body">Waiting for telemetry...</div>
    </div>
  </div>
  <div id="control-panel">
    <strong>Controls</strong>
    <div id="control-grid">
      <button id="btn-takeoff">Take Off</button>
      <button id="btn-mode-guided" class="mode-btn">Guided</button>
      <button id="btn-mode-auto" class="mode-btn">Auto</button>
      <button id="btn-mode-rtl" class="mode-btn">RTL</button>
      <button id="calibrate-toggle" class="inactive">Calibrate</button>
      <button id="slam2gps-toggle" class="inactive">SLAM2GPS</button>
      <button id="btn-save-csv">Save CSV</button>
      <button id="visual-slam-toggle" class="inactive">Visual-SLAM</button>
    </div>
  </div>
  <script type="text/javascript" src="js/main.js"></script>
  <script type="text/javascript" src="/socket.io/socket.io.js"></script>
  <script>
    window.socket = io();

    window.socket.on("map_publish", function (msg) {
      receiveProtobuf(msg)
    });

    window.socket.on("telemetry_update", function (msg) {
      if (typeof updateMavlinkPanel === "function") {
        updateMavlinkPanel(msg);
      }
    });

    let ctx = document.getElementById('thumb').getContext('2d');
    window.socket.on("frame_publish", function (msg) {
      if (msg.image) {
        let img = new Image();
        img.src = 'data:image/jpeg;base64,' + msg.buffer;
        img.onload = function () {
          ctx.drawImage(img, 0, 0, this.width, this.height, 0, 0, CANVAS_SIZE[0], CANVAS_SIZE[1]);
        }
      }
    });

    // load main function
    window.onload = init;
    window.addEventListener("load", function () {
      if (typeof updateMavlinkPanel === "function" && window.__INITIAL_TELEMETRY__) {
        updateMavlinkPanel(window.__INITIAL_TELEMETRY__);
      }
    });
    // listen to the resize events
    window.addEventListener('resize', onResize, false);
  </script>
</body>

</html>
